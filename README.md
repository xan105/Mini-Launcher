About
=====

Mini-Launcher is an application launcher with the following features:

  - DLL Injection
  - Lua Scripting
  - Optional Splash Screen
  - File Integrity Check
  - Expanding Variable
  - Verbatim Arguments
  - Setting Environnement Variables
  - Setting PCA Flags

üêß This software has an emphasis on being compatible with Linux/Proton.
  
üíª This software is for my own personal use but feel free to use it. 
  
Command Line
============

### `--config string` (launcher.json)

File path to the json configuration file to use. Defaults to `launcher.json`.<br />
Path can be absolute or relative (to the current working dir)

### `--dry-run` (false)

Program will exit before starting the executable.

üí° This flag can come in handy when testing Lua Script.

### `--help` (false)

Display a message box with all the command line arguments and a short description.

Config file
===========

```ts
{
  bin: string,
  cwd?: string,
  args?: string,
  env?: object,
  hide?: bool,
  script?: string,
  addons?: []{
    path: string, 
    required?: bool
  },
  integrity?: []{
    sri: string, 
    path?: string, 
    size?: number
  },
  splash?: {
    show: bool,
    image: []string,
    timeout?: number
  },
  symlink?: []{
    path: string,
    dest: string
  },
  compatibility?: {
    version?: string,
    fullscreen?: bool,
    admin?: bool,
    aware?: bool
  }
}
```

### `bin: string`

File path to the executable to launch.<br />
Path can be absolute or relative (to the current working dir).

`%VAR%` are expanded if any (see Expanding Variable for more details).

### `cwd?: string` (parent directory)

An option to override the current working dir of the executable to be launched.<br />
This is equivalent to the "Start In" option of a Windows shortcut.

By default the parent directory of the executable is used.<br />
Example: `G:\METAPHOR\METAPHOR.exe` => `G:\METAPHOR\`

### `args?: string` (none)

Optional argument(s) to pass to the executable.<br />
Argument(s) are passed "verbatim" ie: no quoting or escaping is done.

`%VAR%` are expanded if any (see Expanding Variable for more details).

### `env?: object` (none)

Add additional environment key-value pairs to the executable process.

Example:

```json
{
  "env": {
    "GAMEPAD_LED": "BATTERYLVL"
  }
}
```

`%VAR%` in value are expanded if any (see Expanding Variable for more details).

### `hide?: bool` (false)

When enabled, the executable will run without displaying a window, making it invisible to the user.<br /> 
This is useful for background tasks or command-line utilities that do not require user interaction.

### `script?: string` (none)

File path to a Lua script to be run just before the executable (see Lua Scripting for more details).<br />
Path can be absolute or relative (to the current working dir).

`%VAR%` are expanded if any (see Expanding Variable for more details).

For now this is mainly to handle CD Key generation in old games.

<details>
<summary>Example: Quake 3 Arena keygen</summary>

```lua
local file = require("file")

function keygen()
    local charset = {"2", "3", "7", "a", "b", "c", "d", "g", "h", "j", "l", "p", "r", "s", "t", "w"}
    local key = ""
    for i = 1, 16 do
        key = key .. charset[math.random(#charset)]
    end
    return key
end

function getCurrentKey()
  local read, value = pcall(file.Read, "baseq3/q3key")
  if (not read) then
    return ""
  end

  local current = {}
  for line in value:gmatch("[^\r\n]+") do
      if not line:match("^//") then
          table.insert(current, line)
      end
  end
  return current[1]
end

local current = getCurrentKey()
if (current == "") then
  print("No key found, creating...")
  local arr = {}
  table.insert(arr, keygen())
  table.insert(arr, "// generated by quake, do not modify")
  table.insert(arr, "// Do not give this file to ANYONE.")
  table.insert(arr, "// id Software and Activision will NOT ask you to send this file to them.")
  local key = table.concat(arr, "\n")
  
  local written, err = pcall(file.Write, "baseq3/q3key", key)
  if (not written) then
    print(err)
  end
end
```

</details>

### `addons?: []{ path: string, required?: boolean }` (none)

List of addons to inject to the executable process.<br />
When `required` is set to `true` and if the injection failed, alert the user and kill the process.

Path can be absolute or relative (to the current working dir).<br />
`%VAR%` are expanded if any (see Expanding Variable for more details).

Example:
```json
{
  "addons": [
    { "path": "Launcher/opencnconline.dll", "required": true }
  ]
}
```

> [!IMPORTANT]
> This launcher does not support Wow64 injection so make sure the launcher, the executable and the addon are all the same arch (x86 or x64).

### `integrity?: []{sri: string, path?: string, size?: number}` (none)

Check file(s) integrity before starting the executable.

- `sri: string` 
  is a [Subresource Integrity](https://developer.mozilla.org/en-US/docs/Web/Security/Subresource_Integrity), algo supported are `sha256, sha384, sha512`.

- `path?: string` (executable path) 
  File path, can be absolute or relative (to the current working dir). If no path is specified then the sri targets the executable path.<br />
  `%VAR%` are expanded if any (see Expanding Variable for more details).

- `size?: number`
  optional file size (in bytes), to accelerate sum comparison.
  
### `splash?: { show: bool, image: []string, timeout?: number }` (none)

Display a splash screen until the executable process change the cursor or display a window. The splash screen should be a BMP file. 

- `show: bool` (false)
  Wether to display the splash screen or not.

- `image: []string` 
  Splash screen filepath. When more than one, a splash screen is selected at random.<br />
  File path can be absolute or relative (to the current working dir).<br />
  `%VAR%` are expanded if any (see Expanding Variable for more details).
  
- `timeout?: number` (10 sec)
  Failsafe timeout in seconds.<br />
  There was no event dispatched under Linux/Proton on Wayland in my limited testing.
  
### `symlink?: []{path: string, dest: string}` (none)

Creates folder symlink before starting the executable.<br />
Path can be absolute or relative (to the current working dir).<br />
`%VAR%` are expanded if any (see Expanding Variable for more details).

üí° Useful for savegames:

```json
{
  "symlink": [
    { 
      "path": "%DOCUMENTS%/Telltale Games/The Walking Dead",
      "dest": "%SAVEGAME%/The Walking Dead"
    }
  ]
}
```

> [!CAUTION]
> This requires elevated privileges ("Admin rights") or the `SeCreateSymbolicLinkPrivilege` privilege.

### `compatibility?: { version?: string, fullscreen?: bool, admin?: bool, aware?: bool }`

Set `Program Compatibility Assistant` (PCA) flags, this is equivalent to the `right click > Properties > Compatibility tab` on Windows.

PCA flag(s) are set in `HKCU/Software/Microsoft/Windows NT/CurrentVersion/AppCompatFlags/Layers`.

üêß This has no effect on application behavior under Wine/Proton

- `version?: string`
  Run the executable in compatibility mode for:
    + `WIN95`
    + `WIN98`
    + `WIN2000`
    + `WINXP`
    + `WINXPSP1`
    + `WINXPSP2`
    + `WINXPSP3`
    + `VISTARTM`
    + `VISTASP1`
    + `VISTASP2`
    + `WIN7RTM`
    + `WIN8RTM`
    
- `fullscreen?: bool`
  Disable fullscreen optimizations

- `admin?: bool`
  Run the executable as an Administrator
  
- `aware?: bool`
  Override high DPI scaling behavior (Application)

Expanding Variable
==================

List of variables that will get expanded:

- `%APPDATA%`
- `%LOCALAPPDATA%`
- `%PROGRAMDATA%`
- `%DESKTOP%`
- `%DOCUMENTS%`
- `%MUSIC%`
- `%PICTURES%`
- `%VIDEOS%`
- `%DOWNLOAD%`
- `%SAVEGAME%`
- `%HOMEDIR%`, `%USERPROFILE%`
- `%PUBLIC%` 
- `%SYSTEMDIR%`
- `%TEMP%`, `%TMP%`
- `%CURRENTDIR%`: Current working dir of the mini-launcher
- `%BINDIR%`: Dir where the mini-launcher is located at
- `%USERNAME%`
- `%LOCALE%`: User's locale (ex: `en-US`, `fr-FR`)
- `%LANG%`, `%LANGUAGE%`: User's language (ex: `english`, `french`)
- `%SCREENWIDTH%`: Current primary display horizontal resolution (DPI Aware)
- `%SCREENHEIGHT%`: Current primary display vertical resolution (DPI Aware)
- `%SCREENREFRESH%`: Current primary display refresh rate

Lua Scripting
=============

Very simple scripting engine powered by [yuin/gopher-lua](https://github.com/yuin/gopher-lua).

- Lua 5.1
- Libraries:
  + Package
  + Basic
  + Table
  + String
  + Math
  
Some standard libraries are not enabled by design.<br />
The followings modules are exposed to the Lua VM, I might add more later on.

### üåê Globals

### `sleep(ms int)`

Suspends the execution of the Lua engine until the time-out interval elapses (interval is in milliseconds).

### üì¶ Regedit

This is a module to read and write from/to the registry.

```lua
local regedit = require("regedit")
```

- `QueryStringValue(root: string, path: string, key: string)  string`
- `WriteStringValue(root: string, path: string, key: string, value: string)`

‚úîÔ∏è `root` key accepted values are `"HKCR", "HKCU", "HKLM", "HKU" or "HKCC"`.

#### `QueryStringValue(root: string, path: string, key: string) string`

> REG_SZ & REG_EXPAND_SZ

Return string value of given path/key.

üí°For the default key `@` use `key = ""`

#### `WriteStringValue(root: string, path: string, key: string, value: string)`

> REG_SZ & REG_EXPAND_SZ

Write string value in given path/key (subkeys are created if necessary).

üí°For the default key `@` use `key = ""`

### üì¶ Random

This is a module to generate random things.

```lua
local random = require("random")
```

- `AlphaNumString(length: int) string`

#### `AlphaNumString(length: int) string`

Generate a random alpha numeric string of specified length.

### üì¶ File

This is a module to read and write text data from/to file.

```lua
local file = require("file")
```

- `Write(filename: string, data: string, format?: string = "utf8")`
- `Read(filename: string, format?: string = "utf8") string`

Encoding format:

  - `utf8`
  - `utf8sig`
  - `utf16le`
  - `windows1252`

#### `Write(filename: string, data: string, format?: string = "utf8")`

Overwrite text data with specified format encoding (default to utf8).<br /> 
Create target parent dir if doesn't exist.<br />
File is created if doesn't exist.

`%VAR%` in `filename` are expanded if any (see Expanding Variable for more details).
  
‚ùå This function will raise an error on unexpected error.

#### `Read(filename: string, format?: string = "utf8") string`

Read text data as specified format encoding (default to utf8).

`%VAR%` in `filename` are expanded if any (see Expanding Variable for more details).

‚ùå This function will raise an error on unexpected error.

### üì¶ User

This is a module to get info about the current user.

```lua
local user = require("user")
```

- `name: string` : User name
- `locale: string`: User's locale (ex: `en-US`, `fr-FR`)
- `language: string`: User's language (ex: `english`, `french`)

Build
=====

- Golang v1.24.0
- [go-winres](https://github.com/tc-hib/go-winres) installed in `%PATH%` env var for win32 manifest & cie

Run `build.cmd` on Windows<br/>
Run `build.sh` on Linux<br/>

Output files are located in `./build/${platform}/${config}`
